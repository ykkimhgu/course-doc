# LAB: Input Capture - Ultrasonic

**Date:** 2022-09-26

**Author/Partner:**

**Github:** repository link

**Demo Video:** Youtube link

**PDF version:**

## Introduction

In this lab, you are required to create a simple program that uses input capture mode to measure the distance using an ultrasonic distance sensor. The sensor also needs trigger pulses that can be generated by using the timer output.

You must submit

* LAB Report (\*.md & \*.pdf)
* Zip source files(main\*.c, ecRCC.h, ecGPIO.h, ecSysTick.c etc...).
  * Only the source files. Do not submit project files

### Requirement

#### Hardware

* MCU
  * NUCLEO-F411RE
* Actuator/Sensor/Others:
  * HC-SR04
  * breadboard

#### Software

* Keil uVision, CMSIS, EC\_HAL library

## Problem 1: Create HAL library

### Create HAL library

Declare and Define the following functions in your library. You must update your header files located in the directory `EC \lib\`.

**ecTIM.h**

```
// IC structure
typedef struct{
	GPIO_TypeDef *port;
	int pin;   
	TIM_TypeDef *timer;
	int ch;  		//int Timer Channel
	int ICnum;  //int IC number
} IC_t;

// ICAP setup
void ICAP_init(IC_t *ICx, GPIO_TypeDef *port, int pin);		// Initialize input capture mode (default setting)
void ICAP_setup(IC_t *ICx, int IC_number, int edge_type);	// Setup ICn and Edge type
void ICAP_counter_us(IC_t *ICx, int usec);

// ICAP flag
uint32_t is_CCIF(TIM_TypeDef *TIMx, uint32_t ccNum);
void clear_CCIF(TIM_TypeDef *TIMx, uint32_t ccNum);
```

## Problem 2: Ultrasonic Distance Sensor (HC-SR04)

The HC-SR04 ultrasonic distance sensor. This economical sensor provides 2cm to 400cm of non-contact measurement functionality with a ranging accuracy that can reach up to 3mm. Each HC-SR04 module includes an ultrasonic transmitter, a receiver and a control circuit.

![HC-SR04](https://user-images.githubusercontent.com/91526930/198864049-3dba8f8d-aec8-4f9a-8da3-9adc0fe0e4b9.png)

**The HC-SR04 Ultrasonic Range Sensor Features:**

* Input Voltage: 5V
* Current Draw: 20mA (Max)
* Digital Output: 5V
* Digital Output: 0V (Low)
* Sensing Angle: 30° Cone
* Angle of Effect: 15° Cone
* Ultrasonic Frequency: 40kHz
* Range: 2cm - 400cm

### Procedure

1\. Create a new project under the directory `\repos\EC\LAB\LAB_Timer_InputCaputre_Ultrasonic`

* The project name is “**LAB\_Timer\_InputCaputre\_Ultrasonic”.**
* Create a new source file named as “**LAB\_Timer\_InputCaputre\_Ultrasonic.c”**

> You MUST write your name on the source file inside the comment section.

2\. Include your updated library in `\repos\EC\lib\` to your project.

* **ecGPIO.h, ecGPIO.c**
* **ecRCC.h, ecRCC.c**
* **ecTIM.h, ecTIM.c**
* **ecPWM.h, ecPWM.c**
* **ecUART.h, ecUART.c**
* **ecSysTick.h, ecSysTick.c**

3\. Connect the HC-SR04 ultrasonic distance sensor to MCU pins(PA6 - trigger, PB10 - echo), VCC and GND

### Measurement of Distance

The program needs to

* Generate a trigger pulse as PWM to the sensor.
* Receive echo pulses from the ultrasonic sensor
* Measure the distance by calculating pulse-width of the echo pulse.
*   Display measured distance in \[cm] on serial monitor of Tera-Term for

    (a) 10mm (b) 50mm (c) 100mm

### Configuration

| System Clock | PWM                                                 | Input Capture                                                                                 |
| ------------ | --------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| PLL (84MHz)  | PA6 (TIM3\_CH1)                                     | PB10 (TIM2\_CH3)                                                                              |
|              | <p>AF, Push-Pull,<br>No Pull-up Pull-down, Fast</p> | AF, No Pull-up Pull-down                                                                      |
|              | <p>PWM period: 50msec<br>pulse width: 10usec</p>    | <p>Counter Clock : 0.1MHz (10us)<br>TI3 -> IC3 (rising edge)<br>TI3 -> IC4 (falling edge)</p> |

### Circuit Diagram

> You need to include the circuit diagram

![image](https://user-images.githubusercontent.com/38373000/192134563-72f68b29-4127-42ac-b064-2eda95a9a52a.png)

### Discussion

1. There can be an over-capture case, when a new capture interrupt occurs before reading the CCR value. When does it occur and how can you calculate the time span accurately between two captures?

> Answer discussion questions

1. In the tutorial, what is the accuracy when measuring the period of 1Hz square wave? Show your result.

> Answer discussion questions

### Code

Your code goes here: [ADD Code LINK such as github](https://github.com/ykkimhgu/EC-student/)

Explain your source code with necessary comments.

```
// YOUR MAIN CODE ONLY
// YOUR CODE
```

**Example Code**

![](https://user-images.githubusercontent.com/91526930/198865712-565ba10b-a82c-497f-919d-78dd88a25bf5.png)

### Results

Experiment images and results

> Show experiment images /results

Add [demo video link](link/)

## Reference

Complete list of all references used (github, blog, paper, etc)

```
```

## Troubleshooting

(Option) You can write Troubleshooting section
